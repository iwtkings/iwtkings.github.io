(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{530:function(s,n,e){"use strict";e.r(n);var a=e(2),t=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),n("p",[s._v("本文整理了 Nginx 常见的命令与配置，希望各位看官对 HTTP 有一定了解并能看懂基础的正则表达式；建议配合笔者的 "),n("a",{attrs:{href:"https://juejin.cn/post/7052224696867094536",target:"_blank",rel:"noopener noreferrer"}},[s._v("《20分钟，巩固你的HTTP知识体系》"),n("OutboundLink")],1),s._v(" 这篇文章一同食用。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/60b020fcfb2f4e75a8c5d53255814884~tplv-k3u1fbpfcp-watermark.awebp?",alt:"other38.gif"}})]),s._v(" "),n("h2",{attrs:{id:"基础命令"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基础命令"}},[s._v("#")]),s._v(" 基础命令")]),s._v(" "),n("p",[s._v("👉 列出 "),n("strong",[s._v("nginx")]),s._v(" 相关软件包")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("yum list | grep nginx\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[n("strong",[s._v("yum list")]),s._v("：列出所有软件清单")]),s._v(" "),n("li",[n("strong",[s._v("yum list installed")]),s._v("：列出已安装软件清单 -- 检测系统中是否安装某个软件")]),s._v(" "),n("li",[n("strong",[s._v("grep")]),s._v("：用于查找文件中符合条件的字符串")])]),s._v(" "),n("p",[s._v("👉 安装 "),n("strong",[s._v("nginx")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("yum install nginx\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("👉 查看 "),n("strong",[s._v("nginx")]),s._v(" 版本信息")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("nginx -v\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("👉  列出 nginx 相关目录")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rpm -ql nginx\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("👉 全格式显示所有 "),n("strong",[s._v("nginx")]),s._v(" 运行进程")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("ps -ef | grep nginx\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[n("strong",[s._v("ps")]),s._v("：列出系统中当前运行的进程")]),s._v(" "),n("li",[n("strong",[s._v("-ef")]),s._v("：-e 显示所有，-f 全格式显示，也可使用 "),n("strong",[s._v("aux")]),s._v("，两者显示风格不同")])]),s._v(" "),n("p",[s._v("👉 开机自启")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 设置开机自启\nsystemctl enable nginx\n\n# 关闭开机自启\nsystemctl disable nginx\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("可用 "),n("strong",[s._v("reboot")]),s._v(" 重启服务器，配合 "),n("strong",[s._v("ps -ef | grep nginx")]),s._v(" 进行测试")]),s._v(" "),n("p",[s._v("👉 启动 & 停止 & 重启 & 重载")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 启动 nginx\nsystemctl start nginx ｜ nginx\n\n# 停止 nginx\nsystemctl stop nginx | nginx -s stop\n\n# 重启 nginx\nsystemctl restart nginx | nginx -s reopen\n\n# 重载 nginx，更改 nginx 配置后需执行\nsystemctl reload nginx | nginx -s reload\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("👉 杀死单个进程")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("kill -9 PID（进程ID）\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("👉  查看 nginx 最终配置")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("nginx -T\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("👉  检查配置项是否有问题，每次更改完先检查后重载")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 当前目录下\nnginx -t\n\n# 不在当前目录\nnginx -t -c <配置路径>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h2",{attrs:{id:"配置文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置文件"}},[s._v("#")]),s._v(" 配置文件")]),s._v(" "),n("p",[n("strong",[s._v("nginx.conf")]),s._v(" 文件默认配置")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b0f5bf94ac4a4a479b8e59249bb1b4ed~tplv-k3u1fbpfcp-watermark.awebp?",alt:"nginx1.png"}})]),s._v(" "),n("p",[n("strong",[s._v("上文日志格式中所涉及变量含义如下：")])]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("变量")]),s._v(" "),n("th",[s._v("含义")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("$remote_addr")]),s._v(" "),n("td",[s._v("客户端地址")])]),s._v(" "),n("tr",[n("td",[s._v("$remote_user")]),s._v(" "),n("td",[s._v("已经过验证的用户名")])]),s._v(" "),n("tr",[n("td",[s._v("$time_local")]),s._v(" "),n("td",[s._v("通用日志格式的本地时间")])]),s._v(" "),n("tr",[n("td",[s._v("$request")]),s._v(" "),n("td",[s._v("完整的原始的请求行")])]),s._v(" "),n("tr",[n("td",[s._v("$status")]),s._v(" "),n("td",[s._v("下发给客户端的响应码")])]),s._v(" "),n("tr",[n("td",[s._v("$body_bytes_sent")]),s._v(" "),n("td",[s._v("下发给客户端的字节数")])]),s._v(" "),n("tr",[n("td",[s._v("$http_referer")]),s._v(" "),n("td",[s._v("当前请求上一次页面访问的地址")])]),s._v(" "),n("tr",[n("td",[s._v("$http_user_agent")]),s._v(" "),n("td",[s._v("客户端agent信息")])]),s._v(" "),n("tr",[n("td",[s._v("$http_x_forwarded_for")]),s._v(" "),n("td",[s._v("获得用户ip")])])])]),s._v(" "),n("h2",{attrs:{id:"静态资源配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#静态资源配置"}},[s._v("#")]),s._v(" 静态资源配置")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server {\n  listen 80;\n  server_name static.deeruby.com;\n\n  location /static {\n    root /home;\n    # alias /home/static;\n\n    autoindex on;             # 开启静态资源目录\n    autoindex_exact_size off; # 文件单位 -- on：字节      off：KB、MB、GB\n    autoindex_localtime off;  # 时间格式 -- on：服务器时间 off：GMT时间\n    autoindex_format html;    # 目录格式\n  }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("访问 "),n("a",{attrs:{href:"https://link.juejin.cn?target=http%3A%2F%2Fstatic.deeruby.com%2Fstatic%2Fother18.png",target:"_blank",rel:"noopener noreferrer"}},[s._v("static.deeruby.com/static/othe…"),n("OutboundLink")],1),s._v(" 成功，即配置成功")]),s._v(" "),n("p",[s._v("👉  "),n("strong",[s._v("root 与 alias 区别")])]),s._v(" "),n("ul",[n("li",[s._v("图中静态资源所在目录为："),n("strong",[s._v("/home/static")]),s._v("；root 查找静态资源的路径为其填写路径拼接 location 路径，alias 则直接寻找其填写路径；")]),s._v(" "),n("li",[s._v("alias 只能用于 location 中；")])]),s._v(" "),n("p",[s._v("👉  "),n("strong",[s._v("autoindex")])]),s._v(" "),n("p",[s._v("开启 "),n("strong",[s._v("autoindex")]),s._v(" 可访问文件根目录")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bbd444007a9745a99c912fd887b825d1~tplv-k3u1fbpfcp-watermark.awebp?",alt:"nginx3.png"}})]),s._v(" "),n("h2",{attrs:{id:"反向代理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反向代理"}},[s._v("#")]),s._v(" 反向代理")]),s._v(" "),n("p",[s._v("👉 我们在服务器上跑一个 node 项目，配置用 "),n("strong",[s._v("域名")]),s._v(" 来代替 "),n("strong",[s._v("ip + 端口")]),s._v(" 访问")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server {\n  listen       80;\n  server_name  nginx.deeruby.com;\n  location / {\n    proxy_pass http://127.0.0.1:3002;\n  }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("其含义为用户访问 nginx.deeruby.com‾\\underline{nginx.deeruby.com}nginx.deeruby.com 的时候，将其反向代理到 127.0.0.1:3002‾\\underline{127.0.0.1:3002}127.0.0.1:3002 上")]),s._v(" "),n("p",[s._v("👉 解决跨域")]),s._v(" "),n("p",[s._v("tips：实际工作中，解决跨域一般为后端配置 CORS，详见笔者 "),n("a",{attrs:{href:"https://juejin.cn/post/7052224696867094536#heading-3",target:"_blank",rel:"noopener noreferrer"}},[s._v("20分钟，巩固你的HTTP知识体系"),n("OutboundLink")],1),s._v(" 这篇文章中 "),n("strong",[s._v("HTTP请求方法")]),s._v(" 里 "),n("strong",[s._v("Options")]),s._v(" 部分")]),s._v(" "),n("p",[n("strong",[s._v("hosts 配置")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("127.0.0.1       nginx.deeruby.com\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[n("strong",[s._v("nginx 配置")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server {\n  listen       80;\n  server_name  nginx.deeruby.com;\n\n  location / {\n    proxy_pass http://127.0.0.1:8080;\n  }\n  \n   location /api {\n      proxy_pass http://127.0.0.1:3002;\n      proxy_set_header Host $host;\n  }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("其含义为用户访问 nginx.deeruby.com‾\\underline{nginx.deeruby.com}nginx.deeruby.com 的时候，将其反向代理到 127.0.0.1:8080‾\\underline{127.0.0.1:8080}127.0.0.1:8080 上（前端部分）；访问 nginx.deeruby.com/api‾\\underline{nginx.deeruby.com/api}nginx.deeruby.com/api 的时候，将其反向代理到 127.0.0.1:3002/api‾\\underline{127.0.0.1:3002/api}127.0.0.1:3002/api 上（后端部分）；此时前后端同域，以此解决跨域问题。")]),s._v(" "),n("p",[n("code",[s._v("proxy_set_header Host $host;")]),s._v("：用来在后端获取用户发送过来的请求头，我们看图说话，第一行输出为没配置该指令，第二行为配置了该指令")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4fade2add07f489b8bb389c414f45eb5~tplv-k3u1fbpfcp-watermark.awebp?",alt:"nginx4.png"}})]),s._v(" "),n("h2",{attrs:{id:"https"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#https"}},[s._v("#")]),s._v(" HTTPS")]),s._v(" "),n("p",[n("strong",[s._v("配置HTTPS")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server {\n  listen 443 ssl;                                      # 采用443端口，开启ssl\n  listen [::]:443 ssl;\n  server_name sso.deeruby.com;\n\n  # 证书配置\n  ssl_certificate /etc/nginx/ssl/sso/full_chain.pem;   # pem 文件路径\n  ssl_certificate_key /etc/nginx/ssl/sso/private.key;  # key 文件路径\n\n  ssl_session_cache shared:SSL:1m;                     # 共享缓存大小\n  ssl_session_timeout 5m;                              # 超时时间\n  ssl_ciphers HIGH:!aNULL:!MD5;                        # 加密算法\n  ssl_prefer_server_ciphers on;                        # 优先采取服务器算法\n\n  location / {\n    proxy_pass http://127.0.0.1:3002;\n  }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("👉 访问 HTTP 自动跳转至 HTTPS")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server {\n  listen       80;\n  server_name  sso.deeruby.com;\n  rewrite ^(.*) https://$server_name$1 permanent;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[n("strong",[s._v("rewrite")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rewrite   <regex>    <replacement>       [flag]\n            正则       跳转后的内容   rewrite支持的flag标记\n            \n[flag]：permanent -- 301 永久重定向；redirect -- 302 临时重定向；\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("故上文配置表示将当前路径永久重定向到 https://sso.deeruby.com/路径‾\\underline{ https://sso.deeruby.com/路径 }https://sso.deeruby.com/路径 上")]),s._v(" "),n("h2",{attrs:{id:"图片防盗链"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#图片防盗链"}},[s._v("#")]),s._v(" 图片防盗链")]),s._v(" "),n("p",[n("strong",[s._v("引言：referer请求头用于识别访问来源，以此来配置防盗链。")])]),s._v(" "),n("p",[n("strong",[s._v("valid_referers")]),s._v("：设置可访问资源的规则，其不允许的规则 "),n("strong",[s._v("$invalid_referer")]),s._v(" 值为1，对不允许的规则返回403。")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("字段")]),s._v(" "),n("th",[s._v("含义")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("none")]),s._v(" "),n("td",[s._v("允许没有 referer 字段的请求访问资源")])]),s._v(" "),n("tr",[n("td",[s._v("blocked")]),s._v(" "),n("td",[s._v("允许非 HTTP(S) 开头的请求访问资源")])]),s._v(" "),n("tr",[n("td",[s._v("server_names")]),s._v(" "),n("td",[s._v("允许指定域名 / IP 访问资源")])]),s._v(" "),n("tr",[n("td",[s._v("[string]")]),s._v(" "),n("td",[s._v("正则匹配定义可访问资源的网址")])])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("location ~/static/.*\\.(jpg|jpeg|png|gif|webp)$ {\n  root /home;\n  valid_referers *.deeruby.com;\n  if ($invalid_referer) {\n    return 403;\n  }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("上述配置表示只有 ∗.deeruby.com*.deeruby.com∗.deeruby.com 可访问该资源，否则403报错")]),s._v(" "),n("h2",{attrs:{id:"访问限制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#访问限制"}},[s._v("#")]),s._v(" 访问限制")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("location /static {\n  root /home;\n  allow 39.xxx.xxx.xxx;  # allow 允许\n  deny all;              # deny  拒绝\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("表示允许 39.xxx.xxx.xxx 访问该目录，禁止其它所有 IP 访问，其生效顺序为谁先触发谁起作用。")]),s._v(" "),n("h2",{attrs:{id:"禁用请求方法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#禁用请求方法"}},[s._v("#")]),s._v(" 禁用请求方法")]),s._v(" "),n("p",[s._v("仅允许使用 GET、POST、HEAD、OPTIONS 这四种请求，使用其余请求返回403")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("if ($request_method !~ ^(GET|POST|HEAD|OPTIONS)$) {\n  return 403;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h2",{attrs:{id:"缓存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#缓存"}},[s._v("#")]),s._v(" 缓存")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("expires 7d;  # 缓存7天\nexpires -1;  # 不缓存\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("将动态文件与静态文件分别配置，对静态文件设置缓存即为动静分离")]),s._v(" "),n("h2",{attrs:{id:"pc端和移动端使用不同项目"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#pc端和移动端使用不同项目"}},[s._v("#")]),s._v(" PC端和移动端使用不同项目")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("location / {\n  root /home/static/pc;\n  if ($http_user_agent ~* '(mobile|android|iphone|ipod|phone)') {\n    root /home/static/mobile;\n  }\n  index index.html;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("注意：条件语句中不能使用别名，若有需求，可采取折中方案，重定向移动端网址")]),s._v(" "),n("h2",{attrs:{id:"负载均衡"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡"}},[s._v("#")]),s._v(" 负载均衡")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("upstream backserver {              # 存放负载均衡所需变量\n  ip_hash;                         # 根据用户访问 IP 的 hash 分配，这样每个访客固定访问一个后端服务，可有效解决动态网页存在的 session 共享问题\n  # fair;                          # 根据页面大小和加载时间长短智能地进行负载均衡，响应时间短的优先分配\n  server 127.0.0.1:9090; \n  server 127.0.0.1:8080 weight=2;  # 加权，权重越大，被访问概率越大\n  server 127.0.0.1:7070 down;      # 该 server 不参与负载均衡\n  server 127.0.0.1:6060 backup;    # 其余 server 均不可用时，使用这个\n}\nserver {\n  location / {\n    proxy_pass http://backserver;  # 接入负载均衡相关配置\n    proxy_redirect default;\n  }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("h2",{attrs:{id:"限速限流"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#限速限流"}},[s._v("#")]),s._v(" 限速限流")]),s._v(" "),n("p",[n("strong",[s._v("limit_conn 连接频率限制")]),s._v("：TCP连接")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("limit_conn_zone $binary_remote_addr zone=conname:10m;\nserver {\n   limit_conn conname 3;  # 每个 IP 只能发起3个连接\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[n("strong",[s._v("limit_req 请求频率限制")]),s._v("：API请求")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("limit_req_zone $binary_remtoe_addr zone=conname:1m rate=10r/s;\nserver {\n   limit_req zone=conname burst=5 nodelay;  # 最大请求数为5，且超过的请求不延迟\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("table",[n("thead",[n("tr",[n("th",[s._v("内容")]),s._v(" "),n("th",[s._v("含义")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("$binary_remote_addr")]),s._v(" "),n("td",[s._v("这里填写的是限流对象，我们采用客户端IP")])]),s._v(" "),n("tr",[n("td",[s._v("zone=conname")]),s._v(" "),n("td",[s._v("给共享空间设置名称为：conname")])]),s._v(" "),n("tr",[n("td",[s._v("10m")]),s._v(" "),n("td",[s._v("空间大小：10兆")])]),s._v(" "),n("tr",[n("td",[s._v("rate")]),s._v(" "),n("td",[s._v("速率，上述表示每秒最多发起10个请求")])]),s._v(" "),n("tr",[n("td",[s._v("limit_conn")]),s._v(" "),n("td",[s._v("限制每个name对应的连接数")])]),s._v(" "),n("tr",[n("td",[s._v("limit_req")]),s._v(" "),n("td",[s._v("限制每个name对应的请求数")])])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server {\n   limit_rate_after 10m;  # 前10兆大小不限速\n   limit_rate 100k;       # 限速为 100KB/秒\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("这里可用 ab 命令进行压测")]),s._v(" "),n("p",[s._v("ab -n[number] -c[number] -k url")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("字段")]),s._v(" "),n("th",[s._v("含义")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("-n")]),s._v(" "),n("td",[s._v("一共发送多少请求")])]),s._v(" "),n("tr",[n("td",[s._v("-c")]),s._v(" "),n("td",[s._v("同时发送多少请求")])]),s._v(" "),n("tr",[n("td",[s._v("-k")]),s._v(" "),n("td",[s._v("keep-alive")])])])]),s._v(" "),n("h1",{attrs:{id:"其它"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#其它"}},[s._v("#")]),s._v(" 其它")]),s._v(" "),n("p",[s._v("开启gzip")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("gzip on;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);